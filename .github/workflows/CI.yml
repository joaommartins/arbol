on:
  workflow_dispatch:
  merge_group:
  push:
    branches:
      - main
  pull_request:

env:
    CARGO_TERM_COLOR: always

name: Continuous integration

jobs:
  check-version:
    runs-on: ubuntu-latest
    outputs:
      version_changed: ${{ steps.version-check.outputs.version-changed }}
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
        with:
          fetch-depth: 0

      - name: Check if version changed
        id: version-check
        uses: joaommartins/cargo-version-check-action@6a8e9d67603e5dec028b42df62f2028078970611 # v1
        with:
          base-ref: ${{ github.base_ref }}

  clippy-fmt-and-test:
    runs-on: ubuntu-latest
    needs:
      - check-version
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: clippy, rustfmt

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Install cargo-nextest
        uses: taiki-e/install-action@7646916979096be288829d3d80a5e43636357a04 # v2
        with:
          tool: nextest

      - name: Run rustfmt check
        run: cargo fmt --all -- --check

      - name: Run clippy
        run: cargo clippy --all-targets --all-features -- -D warnings

      - name: Run tests (nextest)
        run: cargo nextest run

  build-release-binary:
    needs:
      - check-version
      - clippy-fmt-and-test
    if: needs.check-version.outputs.version_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4

      - name: Install Rust toolchain
        uses: dtolnay/rust-toolchain@stable

      - name: Cache cargo registry and build
        uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v2

      - name: Build release binary
        run: cargo build --release --locked

      - name: Verify binary exists
        run: |
          ls -lh target/release/imposer
          ./target/release/imposer --version
